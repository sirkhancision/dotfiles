#!/usr/bin/env python3

import git
import os
import subprocess
import sys


def get_updates(XBPS_SRC):
    """
    Get a list of the packages with available updates
    """
    updates = sorted((subprocess.run([XBPS_SRC, "show-sys-updates"],
                                     capture_output=True,
                                     text=True).stdout.strip().split("\n")))
    return updates


def select_packages(num_updates, updates):
    """
    Select packages to update
    """
    selected_indexes = input(f"Select from 0-{num_updates-1}: ").split()

    packages = []
    invalid_selections = []

    for index in selected_indexes:
        if index.isdigit() and 0 <= int(index) < num_updates:
            packages.append(updates[int(index)])
        else:
            invalid_selections.append(int(index))

    for invalid_sel_index in invalid_selections:
        print(f"{invalid_sel_index}: Value out of range, ignoring...")

    return packages


def update_all(XBPS_SRC):
    """
    Update all packages that have updates available
    """
    print("\nUpdating packages...")
    subprocess.run([XBPS_SRC, "update-sys"])


def update_packages(XBPS_SRC, updates):
    """
    Update packages that have updates available
    """
    num_updates = len(updates)

    if num_updates <= 1:
        update_all(XBPS_SRC)
        return

    while True:
        method_option = input(
            "Do you want to update ['a']ll packages or ['s']elect which ones "
            "to update? ").lower()

        if method_option == "a":
            update_all(XBPS_SRC)
            break
        elif method_option == "s":
            packages = select_packages(num_updates, updates)

            for pkg in packages:
                print(f"\nUpdating package: {pkg}")
                subprocess.run([XBPS_SRC, "pkg", pkg])

            xbps_install_cmd = "xi " + " ".join(packages)
            subprocess.run(xbps_install_cmd, shell=True)

            break
        else:
            print("Invalid option")


def pull_changes(VOID_PKGS_DIR):
    """
    Pull changes from the remote repository
    """
    repository = git.Repo(VOID_PKGS_DIR)

    if not repository.is_dirty():
        print("Pulling changes...")
        repository.remote("upstream").fetch()
        repository.git.rebase("upstream/master")
    else:
        print("Failed to update repository")
        sys.exit(1)


def main():
    VOID_PKGS_DIR = os.path.expanduser("~/Github/void-packages")
    XBPS_SRC = os.path.join(VOID_PKGS_DIR, "./xbps-src")

    # enter void-packages if not in it already
    if os.getcwd() != VOID_PKGS_DIR:
        os.chdir(VOID_PKGS_DIR)

    # pull changes and update packages
    pull_changes(VOID_PKGS_DIR)
    updates = get_updates(XBPS_SRC)

    if not updates:
        print("No updates available")
        return

    print("The following packages have updates available:")
    for index, pkg in enumerate(updates):
        print(f"[{index}] {pkg}")

    print("\nNOTE: the packages will be built before being installed")

    update_option = input("Do you want to update any of them? <y/n> ").lower()

    if update_option == "y":
        update_packages(XBPS_SRC, updates)
    else:
        print("\nUpdates cancelled")


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\nScript aborted")
        sys.exit(1)
